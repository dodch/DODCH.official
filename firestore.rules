rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is Admin
    function isAdmin() {
      return request.auth != null && request.auth.uid == '4JAqYb2fnEhpqaBv7xWwsFDUXun2';
    }

    // Helper: Validate String Length (prevents buffer overflows/spam)
    function isValidString(text, min, max) {
      return text is string && text.size() >= min && text.size() <= max;
    }

    // Helper: Validate Positive Number
    function isPositiveNumber(num) {
      return num is number && num >= 0;
    }

    // Orders: 
    // - Create: Allow public (enables Guest Checkout)
    // - Read: Admin can read all. Users can read only their own.
    // - Update: Only Admin can update (e.g. change status)
    match /orders/{orderId} {
      // Allow public creation (Guest Checkout) with validation
      allow create: if true
        && request.resource.data.status == 'Pending'
        && isPositiveNumber(request.resource.data.total)
        && request.resource.data.items is list
        && request.resource.data.items.size() > 0;
        
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
      allow update: if isAdmin();
    }

    // Carts: Users can only read/write their own cart
    match /carts/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    } 
    
    // Public Submissions (Newsletter & Contact Form)
    // Allow creation by anyone (guests included), but read/write only by Admin
    match /newsletter/{document=**} {
      // Basic validation to prevent empty spam
      allow create: if true && isValidString(request.resource.data.email, 5, 100);
      allow read, update, delete: if isAdmin();
    }
    match /messages/{document=**} {
      // Allow public contact form submissions
      allow create: if true 
        && isValidString(request.resource.data.email, 5, 100)
        && isValidString(request.resource.data.message, 1, 2000);
      allow read, update, delete: if isAdmin();
    }
  }
}